---
# yaml-language-server: $schema=https://json.schemastore.org/kustomization.json
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: downloads
components:
  - ../../components/common
resources:
  - ./pgo-cluster.yaml
#  - ./databases.yaml
patches:
  - # Add postBuild substitutions to child Kustomizations
    patch: |-
      apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: not-used
      spec:
        postBuild:
          substituteFrom:
            - name: cluster-settings
              kind: ConfigMap
              optional: false
            - name: cluster-secrets
              kind: Secret
              optional: false
    target:
      group: kustomize.toolkit.fluxcd.io
      kind: Kustomization
      labelSelector: substitution.flux.home.arpa/disabled notin (true)
#  - patch: |-
#      - op: add
#        path: /spec/patches
#        value:
#          # Remove this patch after the first backup has completed successfully
#          - patch: |-
#              - op: remove
#                path: /spec/dataSource
#            target:
#              kind: PostgresCluster
#              name: downloads
#          # Add all databases for the downloads cluster here
#          - patch: |-
#              - op: add
#                path: /spec/users
#                value:
#                  - name: prowlarr
#                    databases: [prowlarr_main]
#                    password:
#                      type: AlphaNumeric
#            target:
#              kind: PostgresCluster
#              name: downloads
#  - patch: |
#      - op: add
#        path: /spec/commonMetadata/labels/app.kubernetes.io~1managed-by
#        value: patch
#    target:
#      kind: Kustomization
#      version: kustomize.toolkit.fluxcd.io/v1
#      name: downloads-pgo
