---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name authelia
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: akeyless-secret-store
  target:
    name: *name
    template:
      data:
        AUTHELIA_AUTHENTICATION_BACKEND_LDAP_USER: "{{ .LDAP_SEARCH_BIND_DN }}"
        AUTHELIA_DUO_API_HOSTNAME: "{{ .DUO_API_HOSTNAME }}"
        AUTHELIA_NOTIFIER_SMTP_ADDRESS: 'smtp://{{ .SMTP_HOST }}:{{ .SMTP_PORT }}'
        AUTHELIA_NOTIFIER_SMTP_USERNAME: "{{ .SMTP_USER }}"
        AUTHELIA_STORAGE_POSTGRES_ADDRESS: '{{ .POSTGRES_ADDRESS }}'
        AUTHELIA_STORAGE_POSTGRES_DATABASE: '{{ .POSTGRES_DATABASE }}'
        AUTHELIA_STORAGE_POSTGRES_USERNAME: '{{ .POSTGRES_USERNAME }}'

        WEAVE_OIDC_CLIENT_ID: "{{ .WEAVE_OIDC_CLIENT_ID }}"
        GRAFANA_OIDC_CLIENT_ID: "{{ .GRAFANA_OIDC_CLIENT_ID }}"
        OPEN_WEBUI_OIDC_CLIENT_ID: "{{ .OPEN_WEBUI_OIDC_CLIENT_ID }}"
        PGADMIN_OIDC_CLIENT_ID: "{{ .PGADMIN_OIDC_CLIENT_ID }}"
        SEMAPHORE_OIDC_CLIENT_ID: "{{ .SEMAPHORE_OIDC_CLIENT_ID }}"
        CODER_OIDC_CLIENT_ID: "{{ .CODER_OIDC_CLIENT_ID }}"
  dataFrom:
    - extract:
        key: korg/authelia
    - extract:
        key: korg/coder
    - extract:
        key: korg/duo
    - extract:
        key: korg/grafana
    - extract:
        key: korg/open-webui
    - extract:
        key: korg/pgadmin
    - extract:
        key: korg/qnap
    - extract:
        key: korg/semaphore
    - extract:
        key: korg/smtp2go
    - extract:
        key: korg/weave-gitops
  data:
    - secretKey: POSTGRES_ADDRESS
      remoteRef:
        key: postgres-pguser-authelia
        property: host
      sourceRef: &sourceRef
        storeRef:
          kind: ClusterSecretStore
          name: crunchy-pgo-secrets
    - secretKey: POSTGRES_DATABASE
      remoteRef:
        key: postgres-pguser-authelia
        property: dbname
      sourceRef: *sourceRef
    - secretKey: POSTGRES_USERNAME
      remoteRef:
        key: postgres-pguser-authelia
        property: user
      sourceRef: *sourceRef
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name authelia-files
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: akeyless-secret-store
  target:
    name: *name
    template:
      data:
        AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD: "{{ .LDAP_SEARCH_PASSWORD }}"
        AUTHELIA_DUO_API_INTEGRATION_KEY: "{{ .DUO_INTEGRATION_KEY }}"
        AUTHELIA_DUO_API_SECRET_KEY: "{{ .DUO_SECRET_KEY }}"
        AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: "{{ .OIDC_HMAC_SECRET }}"
        AUTHELIA_NOTIFIER_SMTP_PASSWORD: "{{ .SMTP_PASS }}"
        AUTHELIA_SESSION_SECRET: "{{ .SESSION_SECRET }}"
        AUTHELIA_STORAGE_ENCRYPTION_KEY: "{{ .STORAGE_ENCRYPTION_KEY }}"
        AUTHELIA_STORAGE_POSTGRES_PASSWORD: '{{ .POSTGRES_PASSWORD }}'

        CODER_OIDC_CLIENT_SECRET: "{{ .CODER_OIDC_CLIENT_SECRET | bcrypt }}"
        GRAFANA_OIDC_CLIENT_SECRET: "{{ .GRAFANA_OIDC_CLIENT_SECRET | bcrypt }}"
        OPEN_WEBUI_OIDC_CLIENT_SECRET: "{{ .OPEN_WEBUI_OIDC_CLIENT_SECRET | bcrypt }}"
        PGADMIN_OIDC_CLIENT_SECRET: "{{ .PGADMIN_OIDC_CLIENT_SECRET | bcrypt }}"
        SEMAPHORE_OIDC_CLIENT_SECRET: "{{ .SEMAPHORE_OIDC_CLIENT_SECRET | bcrypt }}"
        WEAVE_OIDC_CLIENT_SECRET: "{{ .WEAVE_OIDC_CLIENT_SECRET | bcrypt }}"
  dataFrom:
    - extract:
        key: korg/authelia
    - extract:
        key: korg/coder
    - extract:
        key: korg/duo
    - extract:
        key: korg/grafana
    - extract:
        key: korg/open-webui
    - extract:
        key: korg/pgadmin
    - extract:
        key: korg/qnap
    - extract:
        key: korg/semaphore
    - extract:
        key: korg/smtp2go
    - extract:
        key: korg/weave-gitops
  data:
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: postgres-pguser-authelia
        property: password
      sourceRef:
        storeRef:
          kind: ClusterSecretStore
          name: crunchy-pgo-secrets
